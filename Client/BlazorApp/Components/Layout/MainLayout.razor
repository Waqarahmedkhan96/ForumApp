@inherits LayoutComponentBase
@implements IDisposable
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthProvider
@inject BlazorApp.Services.Auth.SimpleAuthProvider SimpleAuth
@inject IJSRuntime JS

<div class="min-vh-100 d-flex flex-column">
  <!-- HEADER -->
  <header class="border-bottom bg-white position-sticky top-0" style="z-index:1020;">
    <div class="container-xxl d-flex align-items-center gap-3 py-2 px-3 w-100">

      <!-- Hamburger (sm/md only) -->
      <button class="btn btn-brand-outline d-lg-none"
              type="button"
              data-bs-toggle="offcanvas"
              data-bs-target="#leftNavOffcanvas"
              aria-controls="leftNavOffcanvas"
              aria-label="Open menu">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <a class="navbar-brand fw-bold text-decoration-none" href="/">
        <span class="brand-blazor text-lowercase">Blazor</span><span class="brand-forum fw-semibold">Forum</span>
      </a>

      <div class="d-none d-lg-block header-left-spacer"></div>

      <input class="form-control header-search"
             placeholder="Search blazor forum…"
             @bind="headerSearch" @bind:event="oninput"
             @onkeydown="OnHeaderSearchKey" />

      <!-- Right actions -->
      <div class="ms-auto d-flex align-items-center gap-2">
        <div class="dropdown">
          <button type="button"
                  class="btn btn-brand-outline dropdown-toggle d-flex align-items-center gap-2"
                  data-bs-toggle="dropdown" aria-expanded="false">
            <!-- human icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21a8 8 0 0 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
            <span>@(isLoggedIn ? userName : "Account")</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            @if (!isLoggedIn)
            {
              <li><a class="dropdown-item" href="/login">Sign in</a></li>
              <li><a class="dropdown-item" href="/signup">Sign up</a></li>
            }
            else
            {
              <li><button class="dropdown-item" @onclick="Logout">Log out</button></li>
            }
          </ul>
        </div>
        <a href="/help" class="btn btn-brand">Help</a>
      </div>
    </div>
  </header>

  <main class="container-xxl my-3 app-shell">
    <aside class="left-rail">
      <NavMenu />
    </aside>
    <section>
      @Body
    </section>
    <aside class="right-rail">
      <RightSidebar />
    </aside>
  </main>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="leftNavOffcanvas" aria-labelledby="leftNavLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="leftNavLabel">Navigation</h5>
      <button class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-2">
      <NavMenu />
    </div>
  </div>

  <footer class="text-center text-muted small py-3 border-top bg-white">
    © @DateTime.Now.Year BlazorForum
  </footer>
</div>

@code {
  private string? headerSearch;
  private bool isLoggedIn;
  private string userName = "";

  // keep a handler reference so we can unsubscribe on dispose
  private EventHandler<LocationChangedEventArgs>? _locChangedHandler;

  protected override async Task OnInitializedAsync()
  {
    // Restore cached user (if any) so refresh keeps you logged in
    await SimpleAuth.RestoreFromSessionAsync();

    await UpdateHeaderFromAuthAsync();

    // react to URL changes (close menus / refresh header if needed)
    _locChangedHandler = (_, __) => InvokeAsync(StateHasChanged);
    Nav.LocationChanged += _locChangedHandler;

    // react to auth changes (login/logout) and update header text live
    AuthProvider.AuthenticationStateChanged += OnAuthChanged;
  }

  private async void OnAuthChanged(Task<AuthenticationState> task)
  {
    try
    {
      await task; // ensure completed
      await InvokeAsync(UpdateHeaderFromAuthAsync);
    }
    catch { /* ignore */ }
  }

  private async Task UpdateHeaderFromAuthAsync()
  {
    var auth = await AuthProvider.GetAuthenticationStateAsync();
    isLoggedIn = auth.User.Identity?.IsAuthenticated ?? false;
    userName = auth.User.Identity?.Name ?? "";
    StateHasChanged();
  }

  private void OnHeaderSearchKey(KeyboardEventArgs e)
  {
    if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(headerSearch))
      Nav.NavigateTo($"/posts?title={Uri.EscapeDataString(headerSearch!)}");
  }

  private async Task Logout()
  {
    await SimpleAuth.LogoutAsync();
    await UpdateHeaderFromAuthAsync();
    Nav.NavigateTo("/");
  }

  public void Dispose()
  {
    if (_locChangedHandler is not null)
      Nav.LocationChanged -= _locChangedHandler;
    AuthProvider.AuthenticationStateChanged -= OnAuthChanged;
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      // Ensure Bootstrap dropdowns are wired after first render
      await JS.InvokeVoidAsync("initDropdowns");
    }
  }
}

@page "/comments"
@using ApiContracts.Comments
@using ApiContracts.Users
@inject BlazorApp.Services.Interfaces.ICommentService CommentSvc
@inject BlazorApp.Services.Interfaces.IUserService UserSvc
@inject AuthenticationStateProvider AuthProvider

<h4 class="mb-3">üí¨ My Comments</h4>

<!-- Filters (post id + text) -->
<div class="row g-2 mb-3">
  <div class="col-12 col-md-3">
    <input class="form-control" type="number" placeholder="Filter: Post Id"
           @bind="filterPostIdString" @bind:event="oninput" />
  </div>
  <div class="col-12 col-md-4">
    <input class="form-control" placeholder="Filter: text contains‚Ä¶"
           @bind="filterText" @bind:event="oninput" />
  </div>
  <div class="col-12 col-md-2 d-grid">
    <button class="btn btn-outline-secondary" @onclick="Load">Search</button>
  </div>
</div>

@if (loading)
{
  <div class="d-flex align-items-center gap-2 text-muted my-3">
    <div class="spinner-border spinner-border-sm"></div>
    <span>Loading‚Ä¶</span>
  </div>
}
else if (!string.IsNullOrWhiteSpace(error))
{
  <div class="alert alert-danger">@error</div>
}
else if (currentUserId <= 0)
{
  <div class="alert alert-info">
    Please log in to your account to see and manage your comment history.  @* login required *@
  </div>
}
else
{
  <!-- Create / Edit form -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="mb-3">@((isEditing ? "‚úèÔ∏è Edit comment" : "‚ûï Add comment"))</h5>

      <div class="row g-3">
        <div class="col-12 col-md-3">
          <label class="form-label">Author (you)</label>
          <input class="form-control" value="@($"{currentUserName} ({currentUserId})")" disabled />  @* ADDED *@
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Post Id</label>
          <input type="number" class="form-control" @bind="formPostId" />
        </div>

        <div class="col-12">
          <label class="form-label">Comment</label>
          <textarea class="form-control" rows="3" @bind="formBody"></textarea>
        </div>

        <div class="col-12">
          @if (!isEditing)
          {
            <button class="btn btn-primary" @onclick="Create" disabled="@busy">
              @if (busy) { <span class="spinner-border spinner-border-sm me-1"></span> } Post comment
            </button>
          }
          else
          {
            <button class="btn btn-primary me-2" @onclick="Update" disabled="@busy">
              @if (busy) { <span class="spinner-border spinner-border-sm me-1"></span> } Save
            </button>
            <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
          }

          @if (!string.IsNullOrWhiteSpace(ok)) { <span class="text-success ms-2">@ok</span> }
          @if (!string.IsNullOrWhiteSpace(msg)) { <span class="text-danger ms-2">@msg</span> }
        </div>
      </div>
    </div>
  </div>

  <!-- List -->
  @if (items is null || items.Count == 0 || !itemsFilteredOnlyMine.Any())
  {
    <div class="alert alert-light border">No comments found.</div>
  }
  else
  {
    <div class="vstack gap-2">
      @foreach (var c in itemsFilteredOnlyMine)  @* ADDED: only my comments *@
      {
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <span class="fw-semibold">@currentUserName</span>
                <span class="text-muted">¬∑ Post #@c.PostId</span>
              </div>
              <div class="text-muted small">
                @c.CreatedAt.ToString("dd-MM-yyyy")
              </div>
            </div>
            <div class="mt-1">@c.Body</div>
          </div>
          <div class="card-footer d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" @onclick="() => StartEdit(c)">Edit</button>
            <button class="btn btn-sm btn-outline-danger"  @onclick="() => Delete(c.Id)">Delete</button>
          </div>
        </div>
      }
    </div>
  }
}

@code {
  private List<CommentDto>? items;
  private List<UserDto> users = new();
  private Dictionary<int, string> usersById = new();

  private bool loading, busy, isEditing;
  private string? error, ok, msg;

  private string? filterText;
  private string? filterPostIdString;
  private int? filterPostId => int.TryParse(filterPostIdString, out var v) ? v : null;

  // form
  private int formPostId;
  private string? formBody;
  private int editingId;

  // ADDED: current user
  private int currentUserId;
  private string currentUserName = "Unknown";

  protected override async Task OnInitializedAsync() => await Load();

  private async Task Load()
  {
    loading = true; error = ok = msg = null;
    try
    {
      var auth = await AuthProvider.GetAuthenticationStateAsync();
      currentUserId = int.TryParse(auth.User.FindFirst("Id")?.Value, out var id) ? id : 0;
      currentUserName = auth.User.Identity?.Name ?? "Unknown";

      users = await UserSvc.GetAllUsersAsync();
      usersById = users.ToDictionary(u => u.Id, u => u.UserName);

      items = await CommentSvc.GetAllCommentsAsync();
    }
    catch (Exception ex) { error = ex.Message; }
    finally { loading = false; }
  }

  private IEnumerable<CommentDto> itemsFilteredOnlyMine =>
    (items ?? new())
      .Where(c => c.AuthorUserId == currentUserId)
      .Where(c => !filterPostId.HasValue || c.PostId == filterPostId.Value)
      .Where(c =>
      {
        if (string.IsNullOrWhiteSpace(filterText)) return true;
        return (c.Body?.Contains(filterText, StringComparison.OrdinalIgnoreCase) ?? false);
      });

  private async Task Create()
  {
    msg = ok = null;

    if (currentUserId <= 0)
    {
      msg = "Please log in to your account to create comments."; // login guard
      return;
    }

    if (formPostId <= 0) { msg = "Post Id must be > 0."; return; }
    if (string.IsNullOrWhiteSpace(formBody)) { msg = "Comment cannot be empty."; return; }

    busy = true;
    try
    {
      var created = await CommentSvc.CreateCommentAsync(formPostId, new CreateCommentDto
      {
        PostId = formPostId,
        Body = formBody!,
        AuthorUserId = currentUserId // ADDED
      });

      items ??= new();
      items.Add(created);
      formBody = string.Empty;
      ok = "Comment posted.";
    }
    catch (Exception ex) { msg = ex.Message; }
    finally { busy = false; }
  }

  private void StartEdit(CommentDto c)
  {
    if (c.AuthorUserId != currentUserId) return; // ADDED protect
    isEditing = true;
    editingId = c.Id;
    formPostId = c.PostId;
    formBody = c.Body;
    ok = msg = null;
  }

  private async Task Update()
  {
    msg = ok = null;

    if (currentUserId <= 0)
    {
      msg = "Please log in to update comments."; // login guard
      return;
    }

    if (editingId <= 0) { msg = "No comment selected."; return; }
    if (formPostId <= 0) { msg = "Post Id must be > 0."; return; }
    if (string.IsNullOrWhiteSpace(formBody)) { msg = "Comment cannot be empty."; return; }

    busy = true;
    try
    {
      await CommentSvc.UpdateCommentAsync(editingId, new UpdateCommentDto
      {
        PostId = formPostId,
        Body = formBody!
      });

      var existing = items!.FirstOrDefault(x => x.Id == editingId);
      if (existing is not null)
      {
        existing.PostId = formPostId;
        existing.Body = formBody!;
      }

      ok = "Comment updated.";
      CancelEdit();
    }
    catch (Exception ex) { msg = ex.Message; }
    finally { busy = false; }
  }

  private void CancelEdit()
  {
    isEditing = false;
    editingId = 0;
    formBody = null;
  }

  private async Task Delete(int id)
  {
    msg = ok = null;

    if (currentUserId <= 0)
    {
      msg = "Please log in to delete comments."; // login guard
      return;
    }

    var mine = items?.FirstOrDefault(x => x.Id == id && x.AuthorUserId == currentUserId);
    if (mine is null) return; // ADDED protect

    try
    {
      await CommentSvc.DeleteCommentAsync(id);
      items!.RemoveAll(x => x.Id == id);
      ok = "Comment deleted.";
      StateHasChanged();
    }
    catch (Exception ex) { msg = ex.Message; }
  }
}

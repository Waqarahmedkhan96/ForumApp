@page "/users"
@using ApiContracts.Users
@inject BlazorApp.Services.Interfaces.IUserService UsersSvc
@inject AuthenticationStateProvider AuthProvider
@inject IJSRuntime JS

<h4 class="mb-3">üë• Manage Users</h4>

<!-- Filter -->
<div class="d-flex gap-2 mb-3">
  <input class="form-control" placeholder="Filter by name..."
         @bind="filter" @bind:event="oninput" />
  <button class="btn btn-secondary" @onclick="LoadUsers">Search</button>
</div>

<!-- Create / Edit Form -->
@if (isEditing)
{
  <div class="card mb-4">
    <div class="card-body">
      <h5>‚úèÔ∏è Edit User</h5>
      <div class="mb-3">
        <label class="form-label">User Name</label>
        <input class="form-control" @bind="userModel.UserName" />
      </div>
      <div class="mb-3">
        <label class="form-label">Password</label>
        <input class="form-control" type="password" @bind="userModel.Password" />
      </div>

      <button class="btn btn-primary me-2" @onclick="SaveUser">Update</button>
      <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
    </div>
  </div>
}
else
{
  <!-- ADDED: no Add form for normal users -->
  <div class="alert alert-light border mb-4">
    You can only edit or delete your own account here.
  </div>
}

<!-- Users List -->
@if (users is null)
{
  <p>Loading...</p>
}
else if (users.Count == 0)
{
  <p>No users found.</p>
}
else
{
  <table class="table table-hover">
    <thead>
      <tr>
        <th style="width:80px;">ID</th>
        <th>UserName</th>
        <th style="width:220px;" class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      @foreach (var u in users.Where(u =>
          string.IsNullOrWhiteSpace(filter) ||
          u.UserName.Contains(filter, StringComparison.OrdinalIgnoreCase)))
      {
        var isMe = u.Id == currentUserId;
        <tr>
          <td>@u.Id</td>
          <td>@u.UserName</td>
          <td class="text-end">
            @if (isMe)
            {
              <button class="btn btn-sm btn-outline-primary me-2"
                      @onclick="() => StartEdit(u)">
                Edit
              </button>
              <button class="btn btn-sm btn-outline-danger"
                      @onclick="() => Delete(u.Id, u.UserName)">
                Delete
              </button>
            }
            else
            {
              <span class="text-muted small">‚Äî no access ‚Äî</span>
            }
          </td>
        </tr>
      }
    </tbody>
  </table>
}

@code {
  private List<UserDto>? users;
  private string? filter;

  private CreateUserDto userModel = new() { UserName = "", Password = "" };
  private bool isEditing = false;
  private int editingUserId;

  // ADDED
  private int currentUserId;

  protected override async Task OnInitializedAsync()
  {
    var auth = await AuthProvider.GetAuthenticationStateAsync();
    currentUserId = int.TryParse(auth.User.FindFirst("Id")?.Value, out var id) ? id : 0;
    await LoadUsers();
  }

  private async Task LoadUsers()
  {
    users = await UsersSvc.GetAllUsersAsync();
    StateHasChanged();
  }

  private async Task SaveUser()
  {
    if (editingUserId != currentUserId) return; // ADDED: protect

    var updateDto = new UpdateUserDto
    {
      UserName = userModel.UserName,
      Password = userModel.Password
    };
    await UsersSvc.UpdateUserAsync(editingUserId, updateDto);

    isEditing = false;
    userModel = new CreateUserDto { UserName = "", Password = "" };
    await LoadUsers();
  }

  private void StartEdit(UserDto u)
  {
    if (u.Id != currentUserId) return; // ADDED: protect

    editingUserId = u.Id;
    userModel.UserName = u.UserName;
    userModel.Password = "";
    isEditing = true;
  }

  private void CancelEdit()
  {
    isEditing = false;
    userModel = new CreateUserDto { UserName = "", Password = "" };
  }

  private async Task Delete(int id, string name)
  {
    if (id != currentUserId) return; // ADDED: protect

    var msg =
      $"Delete your account '{name}' (ID {id})?\n\n" +
      "This will permanently delete ALL your posts and ALL your comments.";
    var ok = await JS.InvokeAsync<bool>("confirm", msg);
    if (!ok) return;

    await UsersSvc.DeleteUserAsync(id);
    users!.RemoveAll(x => x.Id == id);
    StateHasChanged();
  }
}
